<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp envio mensagem inicial)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 12px;
    }
    .container {
      background-color: #ffffff;
      border-radius: 4px;
      padding: 12px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    h1 {
      font-size: 16px;
      margin: 0 0 8px 0;
    }
    .status {
      font-size: 13px;
      margin-top: 8px;
      color: #555;
      white-space: pre-line;
    }
    .success {
      color: #0a7f2e;
    }
    .error {
      color: #b00020;
    }
    .details {
      font-size: 11px;
      margin-top: 6px;
      color: #777;
    }
    .hidden {
      display: none;
    }
    button {
      margin-top: 10px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mensagem inicial WhatsApp </h1>
    <div id="status" class="status">Iniciando widget…</div>
    <div id="details" class="details hidden"></div>
    <button id="retryBtn" class="hidden">Tentar novamente</button>
  </div>

  <script>
    // ====== CONFIGURAÇÕES ======
    
    const ENVIRONMENT = 'https://api.sae1.pure.cloud';

    // ====== UTILITÁRIOS ======
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function setStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.classList.remove('success', 'error');
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
    }

    function setDetails(message) {
      const detailsEl = document.getElementById('details');
      if (message) {
        detailsEl.textContent = message;
        detailsEl.classList.remove('hidden');
      } else {
        detailsEl.textContent = '';
        detailsEl.classList.add('hidden');
      }
    }

    function showRetry(show) {
      const btn = document.getElementById('retryBtn');
      if (show) btn.classList.remove('hidden');
      else btn.classList.add('hidden');
    }

    // ====== CANNED RESPONSE: buscar e aplicar placeholder ======
    async function getCannedResponseWithAgent(token, responseId) {
      const agentName = getQueryParam('agentName') || '';
      const placeholder = getQueryParam('placeholder') || '{{Agent_name}}'; // default comum. 
      if (!responseId) {
        throw new Error('msgId (ID da canned response) não informado na URL.');
      }

      const url = `${ENVIRONMENT}/api/v2/responses/${encodeURIComponent(responseId)}`; 

      const resp = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!resp.ok) {
        const t = await resp.text().catch(() => '');
        throw new Error(`Erro ao buscar canned response ${responseId}. HTTP ${resp.status}: ${t}`);
      }

      const data = await resp.json();

      // Campo típico para responses de mensagem. 
      let text = data.text || (data.message && data.message.body) || '';
      if (!text) {
        throw new Error(`Canned response ${responseId} não possui texto utilizável.`);
      }

      // Substitui exatamente o placeholder informado pelo Script.
      // Exemplo: Script manda "{{Agent_name}}" ou "{{AGENT_NAME}}". 
      const escapedPlaceholder = placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(escapedPlaceholder, 'g');
      text = text.replace(regex, agentName);

      return text;
    }

    // ====== CONTEXTO DO CLIENT APP / CONVERSA ======
    async function getClientContext() {
      if (!window.clientApp) {
        throw new Error('ClientApp SDK não disponível no contexto da página.');
      }

      const clientApp = window.clientApp;

      const token = await clientApp.oauth.getToken(); // [web:368]
      const active = await clientApp.conversation.getActive(); // [web:378]

      if (!active || !active.length) {
        throw new Error('Nenhuma conversa ativa encontrada no contexto do agente.');
      }

      const conversation = active[0];

      // 
      // Aqui tenta achar uma comunicação de mensagem (WhatsApp) em participants[].messages
      let whatsappComm = null;
      if (Array.isArray(conversation.participants)) {
        for (const p of conversation.participants) {
          if (Array.isArray(p.messages)) {
            whatsappComm = p.messages.find(
              m => m.mediaType === 'message' || m.mediaType === 'messaging'
            );
            if (whatsappComm) break;
          }
        }
      }

      if (!whatsappComm) {
        throw new Error('Não foi possível identificar a comunicação de mensagem (WhatsApp) na conversa ativa.');
      }

      return {
        token,
        conversationId: conversation.id,
        communicationId: whatsappComm.id
      };
    }

    // ====== ENVIO DA MENSAGEM PARA WHATSAPP ======
    async function sendGreetingFromCanned() {
      showRetry(false);
      setDetails('');

      const msgId = getQueryParam('msgId');
      const agentName = getQueryParam('agentName') || '';
      const placeholder = getQueryParam('placeholder') || '{{Agent_name}}';

      if (!msgId) {
        throw new Error('msgId (ID da canned response) não informado.');
      }

      setStatus('Obtendo contexto da conversa…', null);
      const { token, conversationId, communicationId } = await getClientContext();

      setStatus('Carregando canned response e aplicando placeholder…', null);
      const text = await getCannedResponseWithAgent(token, msgId);

      setStatus('Enviando mensagem inicial pelo WhatsApp…', null);

      // Endpoint típico para enviar mensagem em conversa de mensagens existente. 
      const url =
        `${ENVIRONMENT}/api/v2/conversations/messages/${encodeURIComponent(conversationId)}` +
        `/communications/${encodeURIComponent(communicationId)}/messages`;

      const body = { body: text };

      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!resp.ok) {
        const errorText = await resp.text().catch(() => '');
        throw new Error(`Erro ao enviar mensagem. HTTP ${resp.status}: ${errorText}`);
      }

      setStatus('Mensagem inicial enviada com sucesso usando canned response.', 'success');
      setDetails(
        `Canned: ${msgId}\nAgente: ${agentName}\nPlaceholder: ${placeholder}\nConversationId: ${conversationId}\nCommunicationId: ${communicationId}`
      );
    }

    // ====== INICIALIZAÇÃO ======
    async function init() {
      try {
        setStatus('Iniciando widget de saudação WhatsApp (canned)…', null);
        await sendGreetingFromCanned();
      } catch (e) {
        console.error(e);
        setStatus('Erro ao enviar a mensagem inicial.', 'error');
        setDetails(e.message || String(e));
        showRetry(true);
      }
    }

    document.getElementById('retryBtn').addEventListener('click', () => {
      init();
    });

    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  </script>
</body>
</html>
