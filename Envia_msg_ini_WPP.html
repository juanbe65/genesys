<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Enviando Mensagem WhatsApp (SAE1)</title>
    <script src="https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #333; text-align: center; padding: 20px; }
        .loading { color: #0056b3; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; margin-top: 10px;}
        .error { color: #dc3545; background-color: #f8d7da; padding: 15px; border-radius: 5px; margin-top: 10px; border: 1px solid #dc3545;}
        .hidden { display: none; }
    </style>
</head>
<body>


    
    <h3>Processando Envio...</h3>
    <div id="status" class="loading">Iniciando SDK (São Paulo)...</div>

    <script>

            
fetch('https://sdk-cdn.mypurecloud.com/javascript/latest/purecloud-platform-client-v2.min.js')
  .then(resp => {
    if (resp.ok) {
      console.log('✅ CDN acessível dentro do iframe');
    } else {
      console.error('⚠️ CDN respondeu com erro:', resp.status);
    }
  })
  .catch(err => {
    console.error('❌ Erro ao acessar CDN dentro do iframe:', err);
    document.getElementById('status').innerText = 'Falha ao acessar CDN.';
  });




        
        // --- 1. CONFIGURAÇÃO INICIAL ---
        const CLIENT_ID = '949da364-56b5-41f6-a18c-525e4d8ad305'; // <--- INSIRA SEU CLIENT ID AQUI
        
        // A Região de São Paulo deve ser configurada exatamente assim:
        const REGION = 'sae1.pure.cloud'; 

        // Captura a URL atual para o redirecionamento pós-login
        const REDIRECT_URI = window.location.href.split('?')[0]; 

        // --- 2. INICIALIZAÇÃO DO SDK (CORREÇÃO WEB) ---
        // Em HTML puro, não usamos 'require'. Usamos o objeto global window.platformClient
        const platformClient = window.platformClient;
        const client = platformClient.ApiClient.instance;
        
        // Configura a região para São Paulo
        client.setEnvironment(REGION);
        
        // Persistência mantém o token salvo para não recarregar login toda vez
        client.setPersistSettings(true, 'whatsapp_sender_sae1');

        // --- 3. UTILITÁRIOS DE TELA ---
        const statusDiv = document.getElementById('status');
        function updateStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = type || "loading";
        }

        // --- 4. LÓGICA PRINCIPAL ---
        
        // Captura parâmetros da URL vindos do Script
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('conversationId'); 
        const responseId = urlParams.get('responseId');
        const varName = urlParams.get('varName');
        const varValue = urlParams.get('varValue');

        // Inicia Autenticação Implicit Grant
        client.loginImplicitGrant(CLIENT_ID, REDIRECT_URI)
            .then(() => {
                console.log("Autenticado com sucesso na região " + REGION);

                if (!conversationId || !responseId) {
                    throw new Error("Parâmetros obrigatórios ausentes (conversationId ou responseId).");
                }

                updateStatus("Buscando modelo de resposta...");
                
                // Instancia APIs
                const responseApi = new platformClient.ResponseManagementApi();
                const conversationsApi = new platformClient.ConversationsApi();

                // Busca o texto da Canned Response
                // Passamos conversationsApi.getConversation adiante para otimizar o fluxo
                return Promise.all([
                    responseApi.getResponsemanagementResponse(responseId),
                    conversationsApi.getConversation(conversationId)
                ]);
            })
            .then(([cannedResponse, conversation]) => {
                // --- TRATAMENTO DO TEXTO DA MENSAGEM ---
                let messageText = "";

                // Verifica se a resposta tem texto
                if (cannedResponse.texts && cannedResponse.texts.length > 0) {
                    messageText = cannedResponse.texts[0].content;
                } else {
                    throw new Error("A Canned Response selecionada está vazia.");
                }

                // Substituição da Variável (Ex: {{NOME}} -> João)
                if (varName && varValue) {
                    console.log(`Substituindo {{${varName}}} por "${varValue}"`);
                    // Cria Regex seguro para substituir todas as ocorrências
                    const regex = new RegExp('{{' + varName + '}}', 'gi');
                    messageText = messageText.replace(regex, varValue);
                }

                updateStatus("Localizando cliente na conversa...");

                // --- LOCALIZAÇÃO DO COMMUNICATION ID ---
                // Procura participante do tipo 'customer' ou 'external'
                const customer = conversation.participants.find(p => p.purpose === 'customer' || p.purpose === 'external');
                
                if (!customer) throw new Error("Participante 'customer' não encontrado.");
                
                // O WhatsApp sempre gera uma sessão de mensagens. Pegamos o ID dela.
                // Nota: Verificamos se existe o array messages e se tem itens.
                const messageSession = (customer.messages && customer.messages.length > 0) 
                                        ? customer.messages[0] 
                                        : null;

                if (!messageSession) {
                    // Fallback: Tenta buscar chamadas (calls) se for um cenário hibrido, mas foco é msg
                    throw new Error("Sessão de mensagem (messageId) não encontrada para o cliente.");
                }

                const communicationId = messageSession.id;

                updateStatus("Enviando mensagem (Contexto do Agente)...");

                // --- ENVIO FINAL ---
                const conversationsApi = new platformClient.ConversationsApi();
                const body = { "textBody": messageText };

                // Endpoint: /api/v2/conversations/messages/{conversationId}/communications/{communicationId}/messages
                return conversationsApi.postConversationsMessagesCommunicationMessages(
                    conversationId, 
                    communicationId, 
                    body
                );
            })
            .then(() => {
                updateStatus("Mensagem enviada com sucesso!", "success");
                console.log("Envio concluído.");
            })
            .catch((err) => {
                console.error("Erro no processo:", err);
                // Tenta extrair mensagem de erro legível da API
                let errorMsg = err.message;
                if(err.body && err.body.message) {
                    errorMsg += " - " + err.body.message;
                }
                updateStatus("Falha: " + errorMsg, "error");
            });
    </script>
</body>
</html>



